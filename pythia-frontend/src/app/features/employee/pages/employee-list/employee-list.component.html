<div class="employee-list-page" [class.ultra-premium-page]="ultraPremiumMode()">
  <!-- Header -->
  <div class="page-header">
    <div class="page-header__content">
      <div class="page-header__title-section">
        <h1 class="page-header__title">
          <mat-icon class="page-header__icon">people</mat-icon>
          Employees
        </h1>
        <div class="page-header__stats">
          <span class="stat">
            <strong>{{ filteredCount() }}</strong> of <strong>{{ totalCount() }}</strong>
          </span>
          <span class="stat stat--available">
            <mat-icon>check_circle</mat-icon>
            {{ availableCount() }} available
          </span>
        </div>
      </div>

      <div class="page-header__actions">
        <!-- Add New Profile Button -->
        <button
          mat-raised-button
          color="primary"
          routerLink="/employees/new"
          class="add-employee-btn"
          matTooltip="Create a new employee profile">
          <mat-icon>person_add</mat-icon>
          Add New Profile
        </button>

        <!-- View Toggle -->
        <app-view-toggle
          [viewMode]="viewMode()"
          (viewModeChange)="handleViewModeChange($event)">
        </app-view-toggle>

        <!-- Filter Toggle -->
        <button
          mat-stroked-button
          [class.active]="showFilters()"
          (click)="toggleFilters()"
          matTooltip="Toggle filters">
          <mat-icon>filter_list</mat-icon>
          Filters
        </button>

        <!-- Comparison Mode -->
        <button
          mat-stroked-button
          [class.active]="comparisonMode()"
          [color]="comparisonMode() ? 'primary' : undefined"
          (click)="toggleComparisonMode()"
          matTooltip="Compare employees side-by-side">
          <mat-icon>compare</mat-icon>
          Compare
          @if (selectedEmployees().length > 0) {
            <span class="badge">{{ selectedEmployees().length }}</span>
          }
        </button>

        <!-- Export -->
        <button
          mat-stroked-button
          (click)="exportEmployees()"
          [disabled]="filteredCount() === 0"
          matTooltip="Export to CSV">
          <mat-icon>download</mat-icon>
          Export
        </button>

        <!-- Ultra Premium Mode Toggle -->
        <button
          mat-stroked-button
          [class.active]="ultraPremiumMode()"
          [class.ultra-premium-active]="ultraPremiumMode()"
          (click)="ultraPremiumMode.set(!ultraPremiumMode())"
          matTooltip="Toggle Ultra Premium features (3D tilt, glassmorphism)">
          <mat-icon>auto_awesome</mat-icon>
          Ultra
        </button>

        <!-- Smart Grouping Toggle -->
        <button
          mat-stroked-button
          [class.active]="groupingEnabled()"
          (click)="cycleGroupBy()"
          matTooltip="Group by: {{ groupBy() === 'none' ? 'Off' : groupBy() }}">
          <mat-icon>{{ groupingEnabled() ? 'folder_open' : 'folder' }}</mat-icon>
          @if (groupingEnabled()) {
            <span class="group-label">{{ groupBy() }}</span>
          }
        </button>

        <!-- Analytics (Ultra Premium) -->
        @if (ultraPremiumMode()) {
          <button
            mat-stroked-button
            [class.active]="showAnalytics()"
            (click)="toggleAnalytics()"
            matTooltip="View team analytics and insights">
            <mat-icon>analytics</mat-icon>
            Analytics
          </button>
        }

        <!-- Refresh -->
        <button
          mat-icon-button
          (click)="refresh()"
          matTooltip="Refresh">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="page-content">
    <!-- Filter Panel (Sidebar) -->
    @if (showFilters()) {
      <aside class="filter-sidebar">
        <app-employee-filter-panel
          [filters]="filters()"
          [employees]="employees()"
          (filtersChange)="handleFiltersChange($event)">
        </app-employee-filter-panel>

        @if (filters().search || filters().availabilityStatuses.length > 0 || filters().departments.length > 0 || filters().seniorities.length > 0 || filters().skills.length > 0) {
          <button
            mat-stroked-button
            class="clear-filters-btn"
            (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Clear All Filters
          </button>
        }
      </aside>
    }

    <!-- Main Content -->
    <main class="main-content" [class.full-width]="!showFilters()">
      <!-- Comparison Mode Banner -->
      @if (comparisonMode()) {
        <div class="comparison-banner">
          <div class="comparison-banner__content">
            <mat-icon>info</mat-icon>
            <span>
              Comparison mode active. Click employees to compare (max 3).
              <strong>{{ selectedEmployees().length }}/3 selected</strong>
            </span>
          </div>
          <button mat-button (click)="clearComparison()">
            <mat-icon>clear</mat-icon>
            Clear Selection
          </button>
        </div>
      }

      <!-- Loading State -->
      @if (loading()) {
        <div class="loading-state">
          <mat-spinner diameter="48"></mat-spinner>
          <p>Loading employees...</p>
        </div>
      }

      <!-- Error State -->
      @else if (error()) {
        <div class="error-state">
          <mat-icon>error_outline</mat-icon>
          <h3>Failed to Load Employees</h3>
          <p>{{ error() }}</p>
          <button mat-raised-button color="primary" (click)="refresh()">
            <mat-icon>refresh</mat-icon>
            Try Again
          </button>
        </div>
      }

      <!-- Empty State (No Results) -->
      @else if (filteredCount() === 0) {
        <div class="empty-state">
          <mat-icon>search_off</mat-icon>
          <h3>No Employees Found</h3>
          <p>Try adjusting your filters or search terms.</p>
          @if (filters().search || filters().availabilityStatuses.length > 0 || filters().departments.length > 0 || filters().seniorities.length > 0 || filters().skills.length > 0) {
            <button mat-raised-button color="primary" (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Clear Filters
            </button>
          }
        </div>
      }

      <!-- Employee Grid View -->
      @else if (viewMode() === 'grid') {
        <!-- Grouped View -->
        @if (groupingEnabled() && groupedEmployees()) {
          <div class="grouped-view">
            @for (group of groupedEmployees(); track group.name) {
              <div class="employee-group">
                <div class="group-header">
                  <h3 class="group-title">
                    <mat-icon>folder_open</mat-icon>
                    {{ group.name }}
                    <span class="group-count">({{ group.count }})</span>
                  </h3>
                </div>
                <div class="employee-grid">
                  @for (employee of group.employees; track employee.id) {
                    <div
                      cdkDrag
                      [cdkDragData]="employee"
                      [cdkDragDisabled]="!ultraPremiumMode()"
                      (cdkDragStarted)="handleEmployeeDragStart(employee)">
                      <app-employee-card
                        [employee]="employee"
                        [selectable]="comparisonMode()"
                        [selected]="isEmployeeSelected(employee.id)"
                        [enable3dTilt]="ultraPremiumMode()"
                        (click)="handleEmployeeClick(employee.id)">
                      </app-employee-card>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
        <!-- Standard View (No Grouping) -->
        @else if (virtualScrollEnabled() && filteredCount() > 20) {
          <cdk-virtual-scroll-viewport
            [itemSize]="GRID_ITEM_HEIGHT"
            class="virtual-scroll-viewport">
            <div class="employee-grid">
              @for (employee of filteredEmployees(); track employee.id) {
                <div
                  cdkDrag
                  [cdkDragData]="employee"
                  [cdkDragDisabled]="!ultraPremiumMode()"
                  (cdkDragStarted)="handleEmployeeDragStart(employee)">
                  <app-employee-card
                    [employee]="employee"
                    [selectable]="comparisonMode()"
                    [selected]="isEmployeeSelected(employee.id)"
                    [enable3dTilt]="ultraPremiumMode()"
                    (click)="handleEmployeeClick(employee.id)">
                  </app-employee-card>
                </div>
              }
            </div>
          </cdk-virtual-scroll-viewport>
        } @else {
          <div class="employee-grid">
            @for (employee of filteredEmployees(); track employee.id) {
              <div
                cdkDrag
                [cdkDragData]="employee"
                [cdkDragDisabled]="!ultraPremiumMode()"
                (cdkDragStarted)="handleEmployeeDragStart(employee)">
                <app-employee-card
                  [employee]="employee"
                  [selectable]="comparisonMode()"
                  [selected]="isEmployeeSelected(employee.id)"
                  [enable3dTilt]="ultraPremiumMode()"
                  (click)="handleEmployeeClick(employee.id)">
                </app-employee-card>
              </div>
            }
          </div>
        }
      }

      <!-- Employee List View -->
      @else if (viewMode() === 'list') {
        @if (virtualScrollEnabled() && filteredCount() > 20) {
          <cdk-virtual-scroll-viewport
            [itemSize]="LIST_ITEM_HEIGHT"
            class="virtual-scroll-viewport list-viewport">
            @for (employee of filteredEmployees(); track employee.id) {
              <app-employee-card-compact
                [employee]="employee"
                [selectable]="comparisonMode()"
                [selected]="isEmployeeSelected(employee.id)"
                (click)="handleEmployeeClick(employee.id)">
              </app-employee-card-compact>
            }
          </cdk-virtual-scroll-viewport>
        } @else {
          <div class="employee-list">
            @for (employee of filteredEmployees(); track employee.id) {
              <app-employee-card-compact
                [employee]="employee"
                [selectable]="comparisonMode()"
                [selected]="isEmployeeSelected(employee.id)"
                (click)="handleEmployeeClick(employee.id)">
              </app-employee-card-compact>
            }
          </div>
        }
      }

      <!-- Gallery View (Large Cards) -->
      @else if (viewMode() === 'gallery') {
        @if (virtualScrollEnabled() && filteredCount() > 20) {
          <cdk-virtual-scroll-viewport
            [itemSize]="GALLERY_ITEM_HEIGHT"
            class="virtual-scroll-viewport">
            <div class="employee-gallery">
              @for (employee of filteredEmployees(); track employee.id) {
                <div
                  cdkDrag
                  [cdkDragData]="employee"
                  [cdkDragDisabled]="!ultraPremiumMode()"
                  (cdkDragStarted)="handleEmployeeDragStart(employee)">
                  <app-employee-card
                    [employee]="employee"
                    [selectable]="comparisonMode()"
                    [selected]="isEmployeeSelected(employee.id)"
                    [enhanced]="true"
                    [enable3dTilt]="ultraPremiumMode()"
                    (click)="handleEmployeeClick(employee.id)">
                  </app-employee-card>
                </div>
              }
            </div>
          </cdk-virtual-scroll-viewport>
        } @else {
          <div class="employee-gallery">
            @for (employee of filteredEmployees(); track employee.id) {
              <div
                cdkDrag
                [cdkDragData]="employee"
                [cdkDragDisabled]="!ultraPremiumMode()"
                (cdkDragStarted)="handleEmployeeDragStart(employee)">
                <app-employee-card
                  [employee]="employee"
                  [selectable]="comparisonMode()"
                  [selected]="isEmployeeSelected(employee.id)"
                  [enhanced]="true"
                  [enable3dTilt]="ultraPremiumMode()"
                  (click)="handleEmployeeClick(employee.id)">
                </app-employee-card>
              </div>
            }
          </div>
        }
      }
    </main>
  </div>

  <!-- Ultra Premium: Drag-to-Compare Panel -->
  @if (ultraPremiumMode() && showComparisonPanel() && comparisonPanel().length > 0) {
    <div class="comparison-panel">
      <div class="comparison-panel__header">
        <div class="comparison-panel__title">
          <mat-icon>compare_arrows</mat-icon>
          <h3>Employee Comparison</h3>
          <span class="comparison-count">{{ comparisonPanel().length }}/3</span>
        </div>
        <div class="comparison-panel__actions">
          <button
            mat-button
            (click)="clearComparisonPanel()"
            matTooltip="Clear all">
            <mat-icon>clear_all</mat-icon>
            Clear
          </button>
          <button
            mat-icon-button
            (click)="toggleComparisonPanel()"
            matTooltip="Minimize">
            <mat-icon>expand_more</mat-icon>
          </button>
        </div>
      </div>

      <div
        class="comparison-panel__content"
        cdkDropList
        [cdkDropListData]="comparisonPanel()"
        (cdkDropListDropped)="reorderComparison($event)"
        cdkDropListOrientation="horizontal">
        @for (employee of comparisonPanel(); track employee.id) {
          <div
            class="comparison-card"
            cdkDrag
            [cdkDragData]="employee">
            <!-- Drag Handle -->
            <div class="drag-handle" cdkDragHandle>
              <mat-icon>drag_indicator</mat-icon>
            </div>

            <!-- Remove Button -->
            <button
              class="remove-btn"
              mat-icon-button
              (click)="removeFromComparison(employee.id)"
              matTooltip="Remove from comparison">
              <mat-icon>close</mat-icon>
            </button>

            <!-- Employee Info -->
            <div class="comparison-card__content">
              <div class="comparison-card__avatar">
                <img
                  [src]="employee.profilePicture || '/assets/images/avatar-placeholder.png'"
                  [alt]="employee.fullName"
                  onerror="this.src='/assets/images/avatar-placeholder.png'" />
              </div>

              <div class="comparison-card__info">
                <h4>{{ employee.fullName }}</h4>
                <p class="title">{{ employee.title }}</p>
                <p class="department">{{ employee.department }}</p>

                <div class="comparison-card__details">
                  <div class="detail-item">
                    <mat-icon>work</mat-icon>
                    <span>{{ employee.seniority }}</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ employee.yearsExperience }} years</span>
                  </div>
                  <div class="detail-item" [class]="'status-' + employee.availability">
                    <mat-icon>circle</mat-icon>
                    <span>{{ employee.availability }}</span>
                  </div>
                </div>

                <div class="comparison-card__skills">
                  @for (tech of employee.technologies.slice(0, 3); track tech.name) {
                    <span class="skill-badge">{{ tech.name }}</span>
                  }
                  @if (employee.technologies.length > 3) {
                    <span class="skill-badge more">+{{ employee.technologies.length - 3 }}</span>
                  }
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Empty Slot Placeholders -->
        @for (i of [1, 2, 3].slice(comparisonPanel().length); track i) {
          <div class="comparison-placeholder">
            <mat-icon>person_add</mat-icon>
            <p>Drag employee here</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Drop Zone Indicator (Shows when Ultra Premium mode is on) -->
  @if (ultraPremiumMode() && !showComparisonPanel()) {
    <div
      class="drop-zone-trigger"
      cdkDropList
      (cdkDropListDropped)="handleEmployeeDrop($event)"
      (click)="toggleComparisonPanel()"
      matTooltip="Drag employees here to compare">
      <mat-icon>compare_arrows</mat-icon>
      <span>Drop to Compare</span>
    </div>
  }

  <!-- Ultra Premium: Advanced Analytics Panel -->
  @if (ultraPremiumMode() && showAnalytics()) {
    <div class="analytics-overlay" (click)="toggleAnalytics()">
      <div class="analytics-modal" (click)="$event.stopPropagation()">
        <div class="analytics-modal__header">
          <div class="analytics-modal__title">
            <mat-icon>analytics</mat-icon>
            <h2>Team Analytics & Insights</h2>
          </div>
          <button
            mat-icon-button
            (click)="toggleAnalytics()"
            matTooltip="Close">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="analytics-modal__content">
          <!-- Department Distribution -->
          <div class="analytics-card">
            <div class="analytics-card__header">
              <mat-icon>business</mat-icon>
              <h3>Department Distribution</h3>
              <span class="analytics-badge">{{ filteredCount() }} total</span>
            </div>
            <div class="analytics-chart">
              @for (dept of departmentDistribution(); track dept.name) {
                <div class="chart-bar-item">
                  <div class="chart-bar-label">
                    <span class="chart-bar-name">{{ dept.name }}</span>
                    <span class="chart-bar-value">{{ dept.count }}</span>
                  </div>
                  <div class="chart-bar-track">
                    <div
                      class="chart-bar-fill chart-bar-fill--department"
                      [style.width.%]="(dept.count / filteredCount()) * 100">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Seniority Distribution -->
          <div class="analytics-card">
            <div class="analytics-card__header">
              <mat-icon>leaderboard</mat-icon>
              <h3>Seniority Levels</h3>
              <span class="analytics-badge">{{ seniorityDistribution().length }} levels</span>
            </div>
            <div class="analytics-chart">
              @for (level of seniorityDistribution(); track level.name) {
                <div class="chart-bar-item">
                  <div class="chart-bar-label">
                    <span class="chart-bar-name">{{ level.name }}</span>
                    <span class="chart-bar-value">{{ level.count }}</span>
                  </div>
                  <div class="chart-bar-track">
                    <div
                      class="chart-bar-fill chart-bar-fill--seniority"
                      [style.width.%]="(level.count / filteredCount()) * 100">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Availability Status -->
          <div class="analytics-card">
            <div class="analytics-card__header">
              <mat-icon>schedule</mat-icon>
              <h3>Availability Status</h3>
              <span class="analytics-badge">{{ availabilityDistribution().length }} statuses</span>
            </div>
            <div class="analytics-stats-grid">
              @for (status of availabilityDistribution(); track status.name) {
                <div class="stat-card" [class]="'stat-card--' + status.name">
                  <div class="stat-card__icon">
                    <mat-icon>
                      @if (status.name === 'available') {
                        check_circle
                      } @else if (status.name === 'busy') {
                        schedule
                      } @else {
                        block
                      }
                    </mat-icon>
                  </div>
                  <div class="stat-card__content">
                    <div class="stat-card__value">{{ status.count }}</div>
                    <div class="stat-card__label">{{ status.name }}</div>
                    <div class="stat-card__percentage">
                      {{ (status.count / filteredCount() * 100).toFixed(1) }}%
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Top Technologies -->
          <div class="analytics-card">
            <div class="analytics-card__header">
              <mat-icon>code</mat-icon>
              <h3>Top Technologies</h3>
              <span class="analytics-badge">Top {{ topTechnologies().length }}</span>
            </div>
            <div class="analytics-chart">
              @for (tech of topTechnologies(); track tech.name) {
                <div class="chart-bar-item">
                  <div class="chart-bar-label">
                    <span class="chart-bar-name">{{ tech.name }}</span>
                    <span class="chart-bar-value">{{ tech.count }} employees</span>
                  </div>
                  <div class="chart-bar-track">
                    <div
                      class="chart-bar-fill chart-bar-fill--technology"
                      [style.width.%]="(tech.count / filteredCount()) * 100">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Top Skills -->
          <div class="analytics-card">
            <div class="analytics-card__header">
              <mat-icon>star</mat-icon>
              <h3>Top Skills</h3>
              <span class="analytics-badge">Top {{ topSkills().length }}</span>
            </div>
            <div class="analytics-chart">
              @for (skill of topSkills(); track skill.name) {
                <div class="chart-bar-item">
                  <div class="chart-bar-label">
                    <span class="chart-bar-name">{{ skill.name }}</span>
                    <span class="chart-bar-value">{{ skill.count }} employees</span>
                  </div>
                  <div class="chart-bar-track">
                    <div
                      class="chart-bar-fill chart-bar-fill--skill"
                      [style.width.%]="(skill.count / filteredCount()) * 100">
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Summary Stats -->
          <div class="analytics-card analytics-card--summary">
            <div class="analytics-card__header">
              <mat-icon>summarize</mat-icon>
              <h3>Summary Statistics</h3>
            </div>
            <div class="summary-grid">
              <div class="summary-stat">
                <mat-icon>people</mat-icon>
                <div class="summary-stat__content">
                  <div class="summary-stat__value">{{ filteredCount() }}</div>
                  <div class="summary-stat__label">Total Employees</div>
                </div>
              </div>
              <div class="summary-stat">
                <mat-icon>check_circle</mat-icon>
                <div class="summary-stat__content">
                  <div class="summary-stat__value">{{ availableCount() }}</div>
                  <div class="summary-stat__label">Available Now</div>
                </div>
              </div>
              <div class="summary-stat">
                <mat-icon>business</mat-icon>
                <div class="summary-stat__content">
                  <div class="summary-stat__value">{{ departmentDistribution().length }}</div>
                  <div class="summary-stat__label">Departments</div>
                </div>
              </div>
              <div class="summary-stat">
                <mat-icon>code</mat-icon>
                <div class="summary-stat__content">
                  <div class="summary-stat__value">{{ topTechnologies().length }}</div>
                  <div class="summary-stat__label">Technologies</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Pagination Controls -->
  @if (totalPages() > 1) {
    <div class="pagination-container">
      <div class="pagination-info">
        <span class="page-stats">
          Showing {{ (currentPage() * pageSize()) + 1 }}-{{ Math.min((currentPage() + 1) * pageSize(), totalElements()) }}
          of {{ totalElements() }} employees
        </span>
      </div>

      <div class="pagination-controls">
        <button
          mat-icon-button
          [disabled]="!hasPreviousPage"
          (click)="previousPage()"
          matTooltip="Previous page"
          class="pagination-btn">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <span class="page-indicator">
          Page {{ currentPage() + 1 }} of {{ totalPages() }}
        </span>

        <button
          mat-icon-button
          [disabled]="!hasNextPage"
          (click)="nextPage()"
          matTooltip="Next page"
          class="pagination-btn">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <div class="page-size-selector">
        <label for="page-size">Per page:</label>
        <select
          id="page-size"
          [value]="pageSize()"
          (change)="handlePageSizeChange(+$any($event.target).value)"
          class="page-size-select">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  }
</div>
