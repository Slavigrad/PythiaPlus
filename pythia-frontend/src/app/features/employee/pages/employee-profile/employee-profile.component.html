<!-- Loading State -->
@if (loading()) {
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Loading employee profile...</p>
  </div>
}

<!-- Error State -->
@else if (error()) {
  <div class="error-container">
    <div class="error-icon"><mat-icon class="error-icon">warning</mat-icon></div>
    <h2>Unable to load profile</h2>
    <p class="error-message">{{ error() }}</p>
    <button class="btn-primary" (click)="goBack()">
      <mat-icon class="icon-xs">arrow_back</mat-icon> Back to Search
    </button>
  </div>
}

<!-- Employee Profile -->
@else if (employee(); as emp) {
  <article class="employee-profile">

    <!-- Back Button -->
    <button class="back-button" (click)="goBack()" aria-label="Back to search">
      <mat-icon class="icon-xs">arrow_back</mat-icon> Back to Search
    </button>

    <!-- HEADER SECTION -->
    <header class="profile-header">
      <div class="header-left">
        <div class="avatar-container">
          @if (emp.profilePicture && emp.profilePicture.startsWith('http')) {
            <img
              [src]="emp.profilePicture"
              [alt]="emp.fullName + ' profile picture'"
              class="avatar"
              loading="eager"
              (error)="onImageError($event)"
            />
          }
          <!-- Always render initials as fallback -->
          <div
            class="avatar-initials"
            [style.background]="getInitialsColor(emp.fullName)"
          >
            {{ getInitials(emp.fullName) }}
          </div>
        </div>

        <div class="header-info">
          <h1 class="employee-name">{{ emp.fullName }}</h1>
          <p class="employee-title">{{ emp.title }}</p>

          <span
            class="status-badge"
            [class]="getAvailabilityClass(emp.availability)"
            role="status"
            [attr.aria-label]="'Employment status: ' + getAvailabilityLabel(emp.availability)">
            <mat-icon class="badge-icon">{{ getAvailabilityIcon(emp.availability) }}</mat-icon> {{ getAvailabilityLabel(emp.availability) }}
          </span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-secondary" (click)="exportCV()" aria-label="Export CV">
          <mat-icon class="icon-sm">download</mat-icon> Export CV
        </button>
      </div>
    </header>

    <!-- Contact Info Grid -->
    <div class="contact-grid">
      <div class="contact-item">
        <mat-icon class="contact-icon">email</mat-icon>
        <a [href]="'mailto:' + emp.email" class="contact-value">{{ emp.email }}</a>
      </div>
      <div class="contact-item">
        <mat-icon class="contact-icon">phone</mat-icon>
        <a [href]="'tel:' + emp.phone" class="contact-value">{{ emp.phone }}</a>
      </div>
    </div>

    <!-- Summary -->
    @if (emp.summary) {
      <div class="summary-section">
        <p class="summary-text">{{ emp.summary }}</p>
      </div>
    }

    <!-- QUICK STATS BAR -->
    <div class="quick-stats-bar" role="region" aria-label="Quick statistics">
      <div class="stat-item">
        <mat-icon class="stat-icon">location_on</mat-icon>
        <span class="stat-value">{{ emp.location }}</span>
      </div>
      <div class="stat-divider">•</div>
      <div class="stat-item">
        <mat-icon class="stat-icon">work</mat-icon>
        <span class="stat-value">{{ emp.yearsExperience }} years</span>
      </div>
      <div class="stat-divider">•</div>
      <div class="stat-item">
        <mat-icon class="stat-icon">business</mat-icon>
        <span class="stat-value">{{ emp.department }}</span>
      </div>
      <div class="stat-divider">•</div>
      <div class="stat-item">
        <mat-icon class="stat-icon">star</mat-icon>
        <span class="stat-value">{{ emp.seniority }}</span>
      </div>
      <div class="stat-divider">•</div>
      <div class="stat-item">
        <mat-icon class="stat-icon">code</mat-icon>
        <span class="stat-value">{{ emp.technologies.length }} Technologies</span>
      </div>
      <div class="stat-divider">•</div>
      <div class="stat-item">
        <mat-icon class="stat-icon">language</mat-icon>
        <span class="stat-value">{{ emp.languages.length }} Languages</span>
      </div>
    </div>

    <!-- MAIN CONTENT GRID -->
    <div class="content-grid">

      <!-- LEFT COLUMN -->
      <div class="left-column">

        <!-- PROJECT HISTORY TIMELINE -->
        @if (sortedWorkExperiences().length > 0) {
          <section class="profile-section" aria-labelledby="project-history-heading">
            <h2 id="project-history-heading" class="section-title">
              <mat-icon class="section-icon">business_center</mat-icon>
              <span class="section-title-text">Project History</span>
              <button
                class="section-edit-btn"
                (click)="editWorkExperience()"
                [attr.aria-label]="'Edit project history'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            <div class="timeline">
              @for (work of sortedWorkExperiences(); track work.id) {
                <div class="timeline-item">
                  <div class="timeline-marker"></div>
                  @if (!$last) {
                    <div class="timeline-line"></div>
                  }

                  <div class="timeline-content">
                    <h3 class="work-role">{{ work.role }}</h3>
                    <p class="work-company">{{ work.company }}</p>
                    <p class="work-dates">
                      <time [attr.datetime]="work.startDate">
                        {{ work.startDate | date:'MMM yyyy' }}
                      </time>
                      -
                      @if (work.endDate) {
                        <time [attr.datetime]="work.endDate">
                          {{ work.endDate | date:'MMM yyyy' }}
                        </time>
                      } @else {
                        <span class="current-position">Present</span>
                      }
                    </p>
                    <p class="work-duration">
                      {{ calculateDuration(work.startDate, work.endDate) }}
                    </p>
                    @if (work.description) {
                      <p class="work-description">{{ work.description }}</p>
                    }
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- EDUCATION -->
        @if (emp.educations.length > 0) {
          <section class="profile-section" aria-labelledby="education-heading">
            <h2 id="education-heading" class="section-title">
              <mat-icon class="section-icon">school</mat-icon>
              <span class="section-title-text">Education</span>
              <button
                class="section-edit-btn"
                (click)="editEducation()"
                [attr.aria-label]="'Edit education'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            @for (edu of emp.educations; track edu.id) {
              <div class="education-card">
                <h3 class="edu-degree">{{ edu.degree }} {{ edu.field }}</h3>
                <p class="edu-institution">{{ edu.institution }}</p>
                <p class="edu-years">
                  {{ edu.startYear }} - {{ edu.endYear }} • {{ edu.endYear - edu.startYear }} years
                </p>
              </div>
            }
          </section>
        }

        <!-- LANGUAGES -->
        @if (emp.languages.length > 0) {
          <section class="profile-section" aria-labelledby="languages-heading">
            <h2 id="languages-heading" class="section-title">
              <mat-icon class="section-icon">language</mat-icon>
              <span class="section-title-text">Languages</span>
              <button
                class="section-edit-btn"
                (click)="editLanguages()"
                [attr.aria-label]="'Edit languages'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            @for (lang of emp.languages; track lang.id) {
              <div class="language-item">
                <div class="language-header">
                  <span class="language-name">{{ lang.name }}</span>
                  @if (lang.level) {
                    <span class="language-level">{{ lang.level }}</span>
                  }
                </div>

                <div
                  class="proficiency-bar"
                  role="img"
                  [attr.aria-label]="lang.name + ' proficiency: ' + (lang.level || 'Unknown')">
                  <div
                    class="bar-fill bar-language"
                    [style.width.%]="getLanguageProficiency(lang.level)">
                  </div>
                </div>

                <p class="language-description">
                  {{ getLanguageDescription(lang.level) }}
                </p>
              </div>
            }
          </section>
        }

      </div>

      <!-- RIGHT COLUMN -->
      <div class="right-column">

        <!-- TECHNOLOGIES -->
        @if (topTechnologies().length > 0) {
          <section class="profile-section" aria-labelledby="technologies-heading">
            <h2 id="technologies-heading" class="section-title">
              <mat-icon class="section-icon">code</mat-icon>
              <span class="section-title-text">Technologies</span>
              <button
                class="section-edit-btn"
                (click)="editTechnologies()"
                [attr.aria-label]="'Edit technologies'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            <div class="tech-list">
              @for (tech of topTechnologies(); track tech.id) {
                <div class="tech-item">
                  <div class="tech-header">
                    <span class="tech-name" [class]="getTechCategoryClass(tech.name)">
                      {{ tech.name }}
                    </span>
                    <span class="tech-years">{{ tech.years }}y</span>
                    <span class="tech-proficiency-label" [class]="getSkillProficiencyClass(tech.proficiency)">
                      {{ tech.proficiency }}
                    </span>
                  </div>

                  <div
                    class="proficiency-bar"
                    role="img"
                    [attr.aria-label]="tech.name + ' proficiency: ' + tech.years + ' years of experience'">
                    <div
                      class="bar-fill"
                      [class]="getTechCategoryClass(tech.name)"
                      [style.width.%]="getProficiencyPercentage(tech.years)">
                    </div>
                  </div>
                </div>
              }
            </div>

            <p class="tech-legend">
              Bar scale: 10 years = 100%
            </p>
          </section>
        }

        <!-- SKILLS -->
        @if (emp.skills.length > 0) {
          <section class="profile-section" aria-labelledby="skills-heading">
            <h2 id="skills-heading" class="section-title">
              <mat-icon class="section-icon">build</mat-icon>
              <span class="section-title-text">Skills</span>
              <button
                class="section-edit-btn"
                (click)="editSkills()"
                [attr.aria-label]="'Edit skills'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            <div class="skills-grid">
              @for (skill of emp.skills; track skill.id) {
                <span
                  class="skill-badge"
                  [class]="getSkillProficiencyClass(skill.proficiency)"
                  [attr.title]="skill.name + ': ' + skill.proficiency + ' (' + skill.years + ' years)'">
                  {{ skill.name }}
                  <span class="skill-years">{{ skill.years }}y</span>
                </span>
              }
            </div>
          </section>
        }

        <!-- CERTIFICATIONS -->
        @if (emp.certifications.length > 0) {
          <section class="profile-section" aria-labelledby="certifications-heading">
            <h2 id="certifications-heading" class="section-title">
              <mat-icon class="section-icon">workspace_premium</mat-icon>
              <span class="section-title-text">Certifications</span>
              <button
                class="section-edit-btn"
                (click)="editCertifications()"
                [attr.aria-label]="'Edit certifications'"
                type="button">
                <mat-icon>edit</mat-icon>
              </button>
            </h2>

            @for (cert of emp.certifications; track cert.id) {
              <div
                class="certification-card"
                [class]="getCertStatusClass(cert.expiresOn)">
                <div class="cert-header">
                  <h3 class="cert-name">{{ cert.name }}</h3>
                  <span
                    class="cert-status"
                    [class]="getCertStatusClass(cert.expiresOn)">
                    {{ getCertStatusLabel(cert.expiresOn) }}
                  </span>
                </div>

                <div class="cert-dates">
                  <div class="cert-date-item">
                    <span class="cert-date-label">Issued:</span>
                    <time [attr.datetime]="cert.issuedOn">
                      {{ cert.issuedOn | date:'MMM yyyy' }}
                    </time>
                  </div>

                  @if (cert.expiresOn) {
                    <div class="cert-date-item">
                      <span class="cert-date-label">Expires:</span>
                      <time [attr.datetime]="cert.expiresOn">
                        {{ cert.expiresOn | date:'MMM yyyy' }}
                      </time>
                    </div>

                    @if (isExpiringSoon(cert.expiresOn) && !isExpired(cert.expiresOn)) {
                      <p class="cert-warning" role="alert">
                        <mat-icon class="error-icon">warning</mat-icon> Expires in {{ getMonthsUntilExpiry(cert.expiresOn) }} months
                      </p>
                    }
                  } @else {
                    <div class="cert-date-item">
                      <span class="cert-no-expiry"><mat-icon class="icon-xs">check_circle</mat-icon> Lifetime certification</span>
                    </div>
                  }
                </div>
              </div>
            }
          </section>
        }

      </div>
    </div>

  </article>
}
